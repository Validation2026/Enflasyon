<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>PIYASA TERMƒ∞NALƒ∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* Premium Tasarƒ±m ve Renk ƒ∞yile≈ütirmeleri */
        :root {
            --bg-body: #0a0a1a;
            --bg-card: #161b33;
        }
        body {
            background: radial-gradient(circle at top, #1e1b4b 0%, #0a0a1a 100%) !important;
        }
        .bot-select {
            appearance: none;
            background: #161b33 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2338bdf8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E") no-repeat right 0.75rem center !important;
            background-size: 1rem !important;
            border: 1px solid rgba(56, 189, 248, 0.2) !important;
            padding-right: 2.5rem !important;
            transition: all 0.3s ease;
        }
        .bot-select:hover {
            border-color: #38bdf8 !important;
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.1);
        }
    </style>
</head>
<body>

    <div id="loading">
        <div class="loader-ring"></div>
        <div style="margin-top: 20px; font-weight: 600; color: #fff; font-family:'Inter';">TERMƒ∞NAL Y√úKLENƒ∞YOR</div>
        <div style="color: #64748b; font-size: 0.8rem; margin-top: 5px; font-family:'Inter';">Veri akƒ±≈üƒ± saƒülanƒ±yor...</div>
    </div>

    <div class="app-container">

        <aside class="sidebar">
            <div class="logo-area">
                <div class="app-name">
                    <div class="app-icon">‚ùñ</div>
                    <span>MONƒ∞T√ñR</span>
                </div>
                <div class="app-sub">ENFLASYON ANALƒ∞Z PANELƒ∞</div>
            </div>

            <div class="bot-container">
                <div class="bot-title"><span>‚è≥</span> GE√áMƒ∞≈û VERƒ∞</div>
                <select id="time-machine-date" class="bot-select" onchange="timeTravel()">
                    <option value="">Y√ºkleniyor...</option>
                </select>
                <div style="font-size:0.65rem; color:#64748b; text-align:center;">
                    BAZ: <span style="color:#f8fafc; font-weight:700;">2025-12-30</span>
                </div>
            </div>

            <div style="height: 1px; background: var(--border-color); margin: 10px 0;"></div>

            <div class="bot-container">
                <div class="bot-title"><span>üìä</span> AKILLI ANALƒ∞Z</div>
                <select id="bot-query" class="bot-select">
                    <option value="top_inc">En √áok Artanlar (G√ºnl√ºk)</option>
                    <option value="top_dec">En √áok D√º≈üenler (G√ºnl√ºk)</option>
                    <option value="cum_inc">Zirve Yapanlar (K√ºm√ºlatif)</option>
                    <option value="cum_dec">Dibe √á√∂kenler (K√ºm√ºlatif)</option>
                    <option value="stable">Fiyatƒ± Sabit Kalanlar</option>
                    <option value="most_exp">Birim Fiyatƒ± En Y√ºksek</option>
                </select>
                <select id="bot-category" class="bot-select">
                    <option value="T√úM√ú">T√ºm Sekt√∂rler</option>
                </select>
                <button class="bot-btn" onclick="askBot()">SORGULA</button>
                <div id="bot-result-area" class="bot-result">
                    <div style="color:#64748b; text-align:center; padding:15px; font-size:0.75rem;">Sonu√ßlar bekleniyor.</div>
                </div>
            </div>

            <div style="margin-top: auto; font-size: 0.65rem; color: #475569; text-align: center;">
                SECURE CONNECTION<br>ID: 492-X12
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <div>
                    <div class="page-title">GENEL BAKI≈û</div>
                    <div class="page-sub">ENFLASYON VE Fƒ∞YAT HAREKETLERƒ∞</div>
                </div>

                <div class="header-right">
                    <button class="refresh-btn" onclick="fetchData(true)">
                        <span style="font-size:1.1rem;">‚Üª</span> VERƒ∞LERƒ∞ YENƒ∞LE
                    </button>
                    <div style="text-align: right;">
                        <div class="clock-label">ƒ∞STANBUL</div>
                        <div id="clock" class="clock-display">--:--:--</div>
                    </div>
                </div>
            </div>

            <div class="ticker-container">
                <div class="ticker-text" id="ticker-content">Veriler y√ºkleniyor...</div>
            </div>

            <div class="kpi-grid" id="kpi-grid"></div>

            <div class="tabs">
                <button class="tab-btn active" onclick="openTab('tab-detay')">KATEGORƒ∞ DETAY</button>
                <button class="tab-btn" onclick="openTab('tab-ozet')">Pƒ∞YASA √ñZETƒ∞</button>
                <button class="tab-btn" onclick="openTab('tab-liste')">TAM Lƒ∞STE</button>
                <button class="tab-btn" onclick="openTab('tab-rapor')">RAPORLAMA</button>
            </div>

            <div id="tab-detay" class="tab-content active">
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <select id="category-select" class="bot-select" style="flex:1; background:#1e293b;" onchange="filterCards()">
                        <option value="T√úM√ú">T√ºm Kategoriler</option>
                    </select>
                    <input type="text" id="search-input" class="bot-select" style="flex:3; background:#1e293b;" placeholder="√úr√ºn Ara..." onkeyup="filterCards()">
                </div>
                <div class="kpi-grid" id="product-cards" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"></div>
            </div>

            <div id="tab-ozet" class="tab-content">
                <div class="glass-panel" style="margin-bottom:20px; padding:15px;">
                    <div style="font-size:0.8rem; font-weight:600; color:#94a3b8; margin-bottom:10px;">Pƒ∞YASA Y√ñN√ú (DERƒ∞NLƒ∞K)</div>
                    <div id="depth-wrapper"></div>
                </div>
                <div class="charts-grid">
                    <div class="glass-panel" style="height: 500px;">
                        <div style="color:#94a3b8; font-weight:700; margin-bottom:10px;">AƒûIRLIK DAƒûILIMI (HEATMAP)</div>
                        <div id="heatmap-chart" style="width:100%; height:90%;"></div>
                    </div>
                    <div class="glass-panel" style="height: 500px;">
                        <div style="color:#94a3b8; font-weight:700; margin-bottom:10px;">ENFLASYON KATKISI (WATERFALL)</div>
                        <div id="waterfall-chart" style="width:100%; height:90%;"></div>
                    </div>
                </div>
            </div>

            <div id="tab-liste" class="tab-content">
                <div class="glass-panel" style="overflow-x: auto;">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>KOD</th>
                                <th>√úR√úN ADI</th>
                                <th>GRUP</th>
                                <th>Fƒ∞YAT</th>
                                <th>G√úNL√úK</th>
                                <th>K√úM√úLATƒ∞F</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-rapor" class="tab-content">
                <div class="glass-panel" style="max-width:800px; margin:0 auto; padding:40px;">
                    <div style="text-align:center; margin-bottom:30px;">
                        <h2 style="color:#fff; margin:0;">G√úNL√úK Pƒ∞YASA RAPORU</h2>
                        <div style="color:#94a3b8; font-size:0.9rem; margin-top:5px;">OTOMATƒ∞K OLU≈ûTURULDU</div>
                    </div>
                    <div id="report-preview" style="white-space: pre-wrap; color:#cbd5e1; line-height:1.7; font-family:'Inter';"></div>
                    <div style="text-align:center; margin-top:30px;">
                        <a href="/api/pdf" class="bot-btn" style="display:inline-block; text-decoration:none; width:auto; padding:12px 40px;">PDF RAPORU ƒ∞NDƒ∞R</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let fullData = [];
        let globalRawData = [];
        let dateColumns = [];
        let baseDateColumn = "";
        let weightColumn = "";

        document.addEventListener("DOMContentLoaded", () => {
            fetchData();
            setInterval(() => {
                const now = new Date();
                const clock = document.getElementById('clock');
                if(clock) clock.innerText = now.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
            }, 1000);
        });

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const tab = document.getElementById(tabName);
            if(tab) tab.classList.add('active');
            if(event && event.target) event.target.classList.add('active');
        }

        function fetchData(force = false) {
            const loading = document.getElementById("loading");
            if(loading) loading.style.display = "flex";

            const url = force ? '/api/dashboard?refresh=true' : '/api/dashboard';

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if(data.error) { alert("HATA: " + data.error); if(loading) loading.style.display="none"; return; }

                    globalRawData = JSON.parse(JSON.stringify(data.full_table));
                    fullData = data.full_table;

                    if(globalRawData.length > 0) {
                        const firstRow = globalRawData[0];
                        const keys = Object.keys(firstRow);
                        const allDates = keys.filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/)).sort();
                        dateColumns = allDates;
                        weightColumn = keys.find(k => k.toLowerCase().includes('agirlik')) || 'Agirlik_2025';

                        const dates2025 = allDates.filter(d => d.includes("2025"));
                        baseDateColumn = dates2025.length > 0 ? dates2025[dates2025.length - 1] : allDates[0];

                        const picker = document.getElementById("time-machine-date");
                        if(picker) {
                            picker.innerHTML = "";
                            const displayDates = allDates.filter(d => d >= "2026-01-01").reverse();
                            displayDates.forEach(date => {
                                const option = document.createElement("option");
                                option.value = date;
                                option.text = date;
                                picker.appendChild(option);
                            });
                            if(displayDates.length > 0) picker.value = displayDates[0];
                        }
                    }

                    renderApp(data);
                    if(loading) loading.style.display = "none";
                })
                .catch(err => {
                    console.error(err);
                    if(loading) loading.style.display = "none";
                });
        }

        function timeTravel() {
            const selectedDate = document.getElementById("time-machine-date").value;
            const loading = document.getElementById("loading");
            if(!selectedDate) return;

            const latestDate = dateColumns[dateColumns.length - 1];
            if(loading) loading.style.display = "flex";

            setTimeout(() => {
                if (selectedDate === latestDate) { fetchData(); return; }

                try {
                    const currentIndex = dateColumns.indexOf(selectedDate);
                    const prevDate = currentIndex > 0 ? dateColumns[currentIndex - 1] : selectedDate;

                    let simulatedData = globalRawData.map(row => {
                        const priceNow = parseFloat(row[selectedDate]) || 0;
                        const pricePrev = parseFloat(row[prevDate]) || priceNow;
                        const priceBase = parseFloat(row[baseDateColumn]) || 0;

                        let dailyChg = (pricePrev > 0) ? (priceNow - pricePrev) / pricePrev : 0;
                        let cumChg = (priceBase > 0) ? (priceNow / priceBase) - 1 : 0;

                        return { ...row, Gunluk_Degisim: dailyChg, Fark: cumChg, [selectedDate]: priceNow };
                    });

                    let totalWeight = 0, weightedSum = 0, foodWeight = 0, foodSum = 0;
                    simulatedData.forEach(row => {
                        const w = parseFloat(row[weightColumn]) || 1;
                        if(row.Fark !== undefined && !isNaN(row.Fark)) {
                            weightedSum += row.Fark * w;
                            totalWeight += w;
                            if((row.Grup || "").includes("Gƒ±da") || (row.Kod || "").startsWith("01")) {
                                foodSum += row.Fark * w;
                                foodWeight += w;
                            }
                        }
                    });

                    const newInfGenel = totalWeight > 0 ? (weightedSum / totalWeight) * 100 : 0;
                    const newInfGida = foodWeight > 0 ? (foodSum / foodWeight) * 100 : 0;

                    fullData = simulatedData;

                    const groups = [...new Set(simulatedData.map(i => i.Grup))];
                    let wfData = groups.map(g => {
                        const sectorRows = simulatedData.filter(r => r.Grup === g);
                        const sVal = sectorRows.reduce((acc, r) => acc + ((r.Fark || 0) * (parseFloat(r[weightColumn]) || 1)), 0);
                        return { Grup: g, Katki: totalWeight > 0 ? (sVal / totalWeight) * 100 : 0 };
                    }).sort((a,b) => b.Katki - a.Katki);

                    renderApp({
                        kpi: {
                            inflation_genel: newInfGenel, inflation_food: newInfGida,
                            forecast: Math.floor(newInfGenel), official: 0, official_date: "-", last_update: selectedDate
                        },
                        ticker: {
                            inc: [...simulatedData].sort((a,b) => b.Gunluk_Degisim - a.Gunluk_Degisim).slice(0, 5),
                            dec: [...simulatedData].sort((a,b) => a.Gunluk_Degisim - b.Gunluk_Degisim).slice(0, 5)
                        },
                        market_depth: {
                            rising: simulatedData.filter(x => x.Gunluk_Degisim > 0).length,
                            falling: simulatedData.filter(x => x.Gunluk_Degisim < 0).length
                        },
                        charts: { heatmap: simulatedData, waterfall: wfData },
                        full_table: simulatedData,
                        report_text: `GE√áMƒ∞≈û D√ñNEM G√ñR√úNT√úLENƒ∞YOR\n\nSe√ßilen ${selectedDate} tarihi itibarƒ±yla sim√ºlasyon.\nBaz Tarih: ${baseDateColumn}`
                    });

                } catch (e) { alert("Hata: " + e.message); }
                finally { if(loading) loading.style.display = "none"; }
            }, 500);
        }

        function renderApp(data) {
            try {
                const kpi = data.kpi;
                const elKpi = document.getElementById("kpi-grid");
                const c_up = "#4ade80", c_down = "#f87171", c_neutral = "#fbbf24", c_blue = "#38bdf8";
                const gColor = kpi.inflation_genel > 0 ? c_down : c_up;

                if(elKpi) {
                    elKpi.innerHTML = `
                        <div class="kpi-card" style="color:${gColor}">
                            <div class="kpi-lbl">AYLIK ENFLASYON</div>
                            <div class="kpi-val" style="color:${gColor}">%${kpi.inflation_genel.toFixed(2)}</div>
                            <div class="kpi-sub">Genel Endeks</div>
                        </div>
                        <div class="kpi-card" style="color:#4ade80">
                            <div class="kpi-lbl">GIDA ENFLASYONU</div>
                            <div class="kpi-val" style="color:#4ade80">%${kpi.inflation_food.toFixed(2)}</div>
                            <div class="kpi-sub">Mutfak Sepeti</div>
                        </div>
                        <div class="kpi-card" style="color:${c_neutral}">
                            <div class="kpi-lbl">AY SONU TAHMƒ∞Nƒ∞</div>
                            <div class="kpi-val" style="color:${c_neutral}">%${kpi.forecast.toFixed(2)}</div>
                            <div class="kpi-sub">Yapay Zeka Modeli</div>
                        </div>
                        <div class="kpi-card" style="color:${c_blue}">
                            <div class="kpi-lbl">RESMƒ∞ VERƒ∞ (${kpi.official_date})</div>
                            <div class="kpi-val" style="color:${c_blue}">%${kpi.official.toFixed(2)}</div>
                            <div class="kpi-sub">T√úƒ∞K A√ßƒ±klamasƒ±</div>
                        </div>
                    `;
                }

                let tickerHtml = "";
                [...data.ticker.inc, ...data.ticker.dec].forEach(item => {
                    const color = item.Gunluk_Degisim > 0 ? c_down : c_up;
                    const arrow = item.Gunluk_Degisim > 0 ? '‚ñ≤' : '‚ñº';
                    tickerHtml += `<span style="color:#e2e8f0; font-weight:600; margin-right: 10px;">${item.Madde_Adi}</span>
                                   <span style="color:${color}; font-weight:700; margin-right: 50px;">${arrow} %${(item.Gunluk_Degisim*100).toFixed(2)}</span>`;
                });
                if(document.getElementById("ticker-content")) document.getElementById("ticker-content").innerHTML = tickerHtml;
                if(document.getElementById("report-preview")) document.getElementById("report-preview").innerText = data.report_text;

                const rising = data.market_depth.rising || 0, falling = data.market_depth.falling || 0, total = rising + falling;
                const risingPct = total > 0 ? (rising / total) * 100 : 50;
                if(document.getElementById("depth-wrapper")) {
                    document.getElementById("depth-wrapper").innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.7rem; font-weight:600; color:#cbd5e1;">
                            <span style="color:${c_down}">‚ñ≤ ${rising} ARTI≈û</span>
                            <span style="color:${c_up}">‚ñº ${falling} D√ú≈û√ú≈û</span>
                        </div>
                        <div style="width:100%; height:6px; background:#334155; border-radius:3px; overflow:hidden; display:flex;">
                            <div style="width:${risingPct}%; background:${c_down};"></div>
                            <div style="width:100%; background:${c_up};"></div>
                        </div>`;
                }

                const hm = data.charts.heatmap;
                if(hm && window.Plotly) {
                    const labels=["Sepet"], parents=[""], values=[0], colors=[0];
                    const groups = [...new Set(hm.map(i=>i.Grup))];
                    groups.forEach(g => { labels.push(g); parents.push("Sepet"); values.push(0); colors.push(0); });
                    hm.forEach(i => {
                        labels.push(i.Madde_Adi); parents.push(i.Grup);
                        values.push(parseFloat(i[weightColumn])||1);
                        colors.push(i.Fark);
                    });
                    Plotly.newPlot('heatmap-chart', [{ type: "sunburst", labels, parents, values, marker: {colors, colorscale:'RdYlGn', reversescale:true}, hoverinfo: "label+value+percent entry" }], { paper_bgcolor:'rgba(0,0,0,0)', margin:{t:0,l:0,r:0,b:0}, font:{family:'Inter', color:'#94a3b8'} });
                }

                const wfData = data.charts.waterfall;
                if(wfData && wfData.length > 0 && window.Plotly) {
                    Plotly.newPlot('waterfall-chart', [{ type: "waterfall", orientation: "v", measure: new Array(wfData.length).fill("relative"), x: wfData.map(d => d.Grup), y: wfData.map(d => d.Katki), text: wfData.map(d => d.Katki.toFixed(2)), textposition: "outside", connector: { line: { color: "#475569" } }, decreasing: { marker: { color: c_up } }, increasing: { marker: { color: c_down } }, totals: { marker: { color: c_neutral } } }], { paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font: {color:'#94a3b8', family:'Inter'}, xaxis: { type: 'category', tickangle: 45 }, yaxis: { gridcolor:'rgba(255,255,255,0.05)' }, margin:{t:20,l:40,r:20,b:80} });
                }

                // Dropdownlarƒ± doldur (Filtreleme hatasƒ± almamak i√ßin √∂nce bu)
                const catSelect = document.getElementById("category-select");
                const botSelect = document.getElementById("bot-category");
                if(catSelect && botSelect) {
                    const groups = [...new Set(data.full_table.map(i=>i.Grup))].sort();
                    let optionsHtml = '<option value="T√úM√ú">T√ºm Kategoriler</option>';
                    groups.forEach(g => { optionsHtml += `<option value="${g}">${g}</option>`; });
                    catSelect.innerHTML = optionsHtml;
                    botSelect.innerHTML = optionsHtml;
                }

                populateTable(data.full_table);
                populateCards(data.full_table);

            } catch(e) { console.error(e); }
        }

        function askBot() {
            const queryType = document.getElementById("bot-query").value;
            const category = document.getElementById("bot-category").value;
            const resultArea = document.getElementById("bot-result-area");
            resultArea.innerHTML = '<div style="text-align:center; color:#3b82f6; padding:20px;">Analiz Ediliyor...</div>';
            setTimeout(() => {
                let filtered = fullData.filter(item => category === "T√úM√ú" || item.Grup === category);
                if(filtered.length === 0) { resultArea.innerHTML = "<div style='color:#64748b; text-align:center;'>Veri bulunamadƒ±.</div>"; return; }

                let suffix = "%", valueKey = "Gunluk_Degisim";
                if (queryType === "top_inc") { filtered.sort((a, b) => b.Gunluk_Degisim - a.Gunluk_Degisim); }
                else if (queryType === "top_dec") { filtered.sort((a, b) => a.Gunluk_Degisim - b.Gunluk_Degisim); }
                else if (queryType === "cum_inc") { filtered.sort((a, b) => b.Fark - a.Fark); valueKey = "Fark"; }
                else if (queryType === "cum_dec") { filtered.sort((a, b) => a.Fark - b.Fark); valueKey = "Fark"; }
                else if (queryType === "stable") { filtered.sort((a, b) => Math.abs(a.Gunluk_Degisim) - Math.abs(b.Gunluk_Degisim)); }
                else if (queryType === "most_exp") {
                    filtered.sort((a, b) => (b[Object.keys(b).find(k => k.match(/^\d{4}-\d{2}-\d{2}$/))] || 0) - (a[Object.keys(a).find(k => k.match(/^\d{4}-\d{2}-\d{2}$/))] || 0));
                    valueKey = "price"; suffix = " ‚Ç∫";
                }
                const top5 = filtered.slice(0, 5);
                let html = "";
                top5.forEach(item => {
                    const priceKey = Object.keys(item).find(k => k.match(/^\d{4}-\d{2}-\d{2}$/));
                    const price = item[priceKey] || 0;
                    let rawVal = (valueKey === "price") ? price : item[valueKey] * 100;
                    let color = (valueKey !== "price") ? (rawVal > 0 ? '#f87171' : (rawVal < 0 ? '#4ade80' : '#fbbf24')) : '#38bdf8';
                    html += `<div class="bot-item" style="border-left: 3px solid ${color}"><div><div style="font-weight:700; color:#f1f5f9;">${item.Madde_Adi}</div><div style="color:#64748b; font-size:0.65rem;">${item.Grup}</div></div><div style="color:${color}; font-weight:700;">${rawVal.toFixed(2)}${suffix}</div></div>`;
                });
                resultArea.innerHTML = html;
            }, 300);
        }

        function populateTable(data) {
            const tbody = document.getElementById("data-table").querySelector("tbody");
            if(!tbody) return;
            let html = "";
            data.forEach(row => {
                const change = row.Gunluk_Degisim * 100;
                let color = change > 0 ? '#f87171' : (change < 0 ? '#4ade80' : '#fbbf24');
                const sonFiyat = row[Object.keys(row).find(k => k.match(/^\d{4}-\d{2}-\d{2}$/))] || 0;
                html += `<tr><td style="color:#64748b; font-family:'JetBrains Mono';">${row.Kod}</td><td style="font-weight:600;">${row.Madde_Adi}</td><td><span style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px; font-size:0.7rem;">${row.Grup}</span></td><td>${typeof sonFiyat === 'number' ? sonFiyat.toFixed(2) : sonFiyat} ‚Ç∫</td><td style="color:${color}; font-weight:700;">%${change.toFixed(2)}</td><td>%${(row.Fark*100).toFixed(2)}</td></tr>`;
            });
            tbody.innerHTML = html;
        }

        function populateCards(data) {
            const container = document.getElementById("product-cards");
            if(!container) return;
            let html = "";

            // Her bir kartƒ±n sƒ±rayla a√ßƒ±lmasƒ± i√ßin 'index' parametresini ekledik
            data.forEach((row, index) => {
                const dailyChange = (row.Gunluk_Degisim || 0) * 100; //
                const sonFiyat = row[Object.keys(row).find(k => k.match(/^\d{4}-\d{2}-\d{2}$/))] || 0;

                let color = dailyChange > 0 ? '#f87171' : (dailyChange < 0 ? '#4ade80' : '#fbbf24');

                // style i√ßine 'animation-delay' ekleyerek her kartƒ±n 0.02s gecikmeyle gelmesini saƒüladƒ±k
                html += `
                    <div class="kpi-card product-card"
                         data-cat="${row.Grup}"
                         data-name="${row.Madde_Adi.toLowerCase()}"
                         style="border-top:3px solid ${color}; animation-delay: ${index * 0.02}s;">
                        <div style="font-size:0.65rem; color:#94a3b8; margin-bottom:5px;">${row.Grup}</div>
                        <div style="font-size:0.85rem; font-weight:700; color:#f1f5f9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${row.Madde_Adi}</div>
                        <div style="display:flex; justify-content:space-between; align-items:end; margin-top:10px;">
                            <div style="font-size:1.1rem; color:#fff;">${typeof sonFiyat === 'number' ? sonFiyat.toFixed(2) : sonFiyat} ‚Ç∫</div>
                            <div style="text-align:right;">
                                <div style="color:${color}; font-weight:700; font-size:0.9rem;">%${dailyChange.toFixed(2)}</div>
                                <div style="color:#64748b; font-size:0.55rem; font-weight:600;">G√úNL√úK</div>
                            </div>
                        </div>
                    </div>`;
            });

            container.innerHTML = html;
            filterCards(); // Kartlar basƒ±ldƒ±ktan sonra filtreleme mantƒ±ƒüƒ±nƒ± tetikler
        }

        function filterCards() {
            const searchInput = document.getElementById("search-input"), categorySelect = document.getElementById("category-select");
            if (!searchInput || !categorySelect) return;
            const search = searchInput.value.toLowerCase(), cat = categorySelect.value, cards = document.querySelectorAll(".product-card");
            let visibleCount = 0;
            cards.forEach(card => {
                const matches = (card.getAttribute("data-name") || "").includes(search) && (cat === "T√úM√ú" || card.getAttribute("data-cat") === cat);
                if (matches && visibleCount < 500) { card.style.display = "block"; visibleCount++; }
                else { card.style.display = "none"; }
            });
        }
    </script>
</body>
</html>